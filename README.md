# Leads ETL 
This is the home repository for all ETL scripts related to the Leads Datamart and Data Lake.

## System PreRequisites
* Python 3.6
* cURL

## Project Setup
Activate your virtual environment and run the following commands
```
$ pip install -r requirements.txt
$ inv update
```

## Development Workflow
1. run the `updateglue` invoke task to make sure you have the most up-to-date `awsglue` library available
2. author a new script in the `gluejobs` directory
3. invoke the `uploadjob` task
4. invoke the `runjob` task

## Invoke Task Reference

### Task: `updateglue`

#### Description: 
downloads and installs the latest `awsglue` package from github.

*Note: Glue jobs can't execute locally.  The only reason we include the `awsglue` package is for code 
hinting in an editor.*

#### Usage:

```
$ inv updateglue
```
- - -
### Task: `uploadjob`

#### Description:
Creates or updates a job script.  The name of the job will be the name of the file minus the extension.  
The `jobfile` argument is a file path in the `./gluejobs` directory.  The job script is located at:
* s3://jornaya-dev-us-east-1-etl-code/glue/jobs/your_job_name

In addition to creating the job, it creates three storage directories in S3:
* s3://jornaya-dev-us-east-1-etl-code/glue/jobs/tmp/your_job_name
* s3://jornaya-dev-us-east-1-etl-code/glue/jobs/staging/your_job_name
* s3://jornaya-dev-us-east-1-etl-code/glue/jobs/output/your_job_name

#### Usage Exmples:
_basic job upload_
```
$ inv uploadjob --jobfile myjobfile.py
```
_job upload from gluejobs subdirectory_
```
$ inv uploadjob --jobfile myfolder/myjobfile.py
```
_job upload with DPU allocation set to 20 (default is 10)_
```
$ inv uploadjob --jobfile myfolder/myjobfile.py --dpu 20
```
- - -
### Task: `runjob`

#### Description
Executes an existing job, then polls the running job every 10 seconds to report back it's status.

#### Usage Examples:
_runs a job using job defaults_
```
$ inv runjob --jobfile myfilefile.py
```
_runs a job using overriden DPU allocation_
```
$ inv runjob --jobfile myfilefile.py --dpu 20
```
- - -
### Task: `getjob`

#### Description
Queries a job run's current status using the jobfile name and the id of the run.

#### Usage Examples:
```
$ inv getjob --jobfile myfilefile.py --jobid jr_e27f4b6971a9e014dc1afbd1941f04d7858ef0c1f871f7a49a3dc4396f680a04
```
## Debugging Scripts
Unfortunately, we have not been unable to create a Glue `dev-endpoint`.  In order to debug the transformations scripts, it's 
necessary to add print statements throughout the code to examine state after each transform operation.  Glue dumps the 
print output to STDERROR and is only available after the job completes by viewing the error logs for any given job run.

## Output Data Types
We have been unable to get anything other than ORC files to write out correctly.  Note that all of our input files were
 in ORC format as well, not sure if this had anything to do with it.
 
## Previewing Output Data
We have found two ways of examining the output files.  The first option is to create a Glue crawler to hit the output 
directory then use the preview button to examine a few rows.  If you want more control, you can create an Athena table 
and run whatever queries you like.  Here are the DDL commands for each of the three main datasets we worked with during
 this project:
 
### Create New table from cli
```aws glue --profile jornaya-dev create-table --database-name nazar_dev_db --table-input file://gluetables/leads.json```
 
```sql
-- This creates a table for accounts based on the data generated by accounts_to_useable.py

CREATE EXTERNAL TABLE IF NOT EXISTS accounts_to_useable (
  active STRING,
  affiliate_click_network STRING,
  api_key STRING,
  audit_auth STRING,
  audit_full STRING,
  audit_pre STRING,
  audit_self STRING,
  call_center STRING,
  code STRING,
  contribute STRING,
  `create` STRING,
  created STRING,
  email STRING,
  entity_code STRING,
  industry STRING,
  lead_aggregator STRING,
  lead_originator STRING,
  legal_agree STRING,
  legal_agreed_date STRING,
  logging STRING,
  marketplace STRING,
  mobile_network STRING,
  modified STRING,
  `name` STRING,
  referral_source STRING,
  `role` STRING,
  status STRING,
  testing STRING,
  website STRING)
STORED AS ORC
LOCATION 's3://jornaya-dev-us-east-1-etl-code/glue/jobs/output/accounts_to_useable/'
tblproperties ("orc.compress"="SNAPPY")
```

```sql
-- This creates a table for campaigns based on the data generated by campaigns_to_useable.py

CREATE EXTERNAL TABLE IF NOT EXISTS campaigns_to_useable (
  account_code STRING,
  audience_id_tags ARRAY<STRING>,
  campaign_javascript_version STRING,
  created STRING,
  created_by STRING,
  description STRING,
  forensiq_default STRING,
  hash_urls STRING,
  `key` STRING,
  log_level STRING,
  log_limit STRING,
  log_target STRING,
  modified STRING,
  modified_by STRING,
  `name` STRING,
  threatmetrix_default STRING
)
STORED AS ORC
LOCATION 's3://jornaya-dev-us-east-1-etl-code/glue/jobs/output/campaigns_to_useable/'
tblproperties ("orc.compress"="SNAPPY")

```

```sql
-- This creates a table for leads based on the data generated by leads_to_useable.py

CREATE EXTERNAL TABLE IF NOT EXISTS leads_to_useable (
  account_code STRING,
  browser STRING,
  browser_maker STRING,
  browser_name STRING,
  browser_name_pattern STRING,
  browser_name_regex STRING,
  campaign_key STRING,
  client_time STRING,
  `comment` STRING,
  created STRING,
  device_pointing_method STRING,
  device_type STRING,
  geoip_city STRING,
  geoip_continent_code STRING,
  geoip_country_code STRING,
  geoip_isp STRING,
  geoip_postal_code STRING,
  geoip_region STRING,
  http_content_length STRING,
  http_user_agent STRING,
  http_x_forwarded_for STRING,
  ip STRING,
  is_mobile_device STRING,
  major_version STRING,
  minor_version STRING,
  page_id STRING,
  parent STRING,
  platform STRING,
  sequence_number STRING,
  token STRING,
  `version` STRING)
STORED AS ORC
LOCATION 's3://jornaya-dev-us-east-1-etl-code/glue/jobs/output/leads_to_useable/'
tblproperties ("orc.compress"="SNAPPY")

```

## Amazon resources
https://docs.aws.amazon.com/glue/latest/dg/aws-glue-api-crawler-pyspark-extensions-python-intro.html
https://forums.aws.amazon.com/forum.jspa?forumID=262&start=0
https://docs.aws.amazon.com/glue/latest/dg/aws-glue-api-etl-scripts-pyspark-transforms.html
https://docs.aws.amazon.com/glue/latest/dg/built-in-transforms.html

## Examples and Libs
https://github.com/search?q=org%3Aawslabs+glue

## ToDo
- [x] If we want the awsglue package to be installable, we should create a setup.py (done)
- [x] check if connections are required when using the aws cli (AWS Fixed this)
